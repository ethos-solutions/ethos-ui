name: Deploy Ethos Applications

on:
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Application to build (fe, ui, admin, customer, co)'
        required: true
        default: 'customer'
        type: choice
        options:
          - fe
          - ui
          - admin
          - customer
          - co
      build_env:
        description: 'Build environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  S3_BUCKET_NAME: "ethos-build"
  BUILD_ENV: ${{ github.event.inputs.build_env || 'production' }}
  APP_TO_BUILD: ${{ github.event.inputs.app_to_build || 'customer' }}
  AWS_REGION: us-east-1
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event.inputs.app_to_build || 'customer' }}
  cancel-in-progress: false

jobs:
  build:
    name: Build & Upload Artifacts (no Nx checks)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      version_sha: ${{ steps.version.outputs.version_sha }}
      artifact_path: ${{ steps.version.outputs.artifact_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm (use version from package.json)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set version and artifact paths
        id: version
        run: |
          VERSION_SHA="${GITHUB_SHA:0:8}"
          ARTIFACT_PATH="artifacts/$APP_TO_BUILD/$VERSION_SHA"
          echo "version_sha=$VERSION_SHA" >> $GITHUB_OUTPUT
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT

      - name: Set environment variables from Parameter Store
        run: |
          if [ "$APP_TO_BUILD" = "fe" ]; then
            if [ "$BUILD_ENV" = "staging" ] || [ "$BUILD_ENV" = "stage" ]; then
              echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL_STAGE' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_API_GRAPH_URL=$(aws ssm get-parameter --name 'VITE_APP_API_GRAPH_URL_STAGE' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            else
              echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_API_GRAPH_URL=$(aws ssm get-parameter --name 'VITE_APP_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            fi
            echo "VITE_APP_SOCKET_URL=$(aws ssm get-parameter --name 'VITE_APP_SOCKET_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_S3_BUCKET_NAME=$(aws ssm get-parameter --name 'VITE_APP_S3_BUCKET_NAME' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_IDENTITY_POOL_ID=$(aws ssm get-parameter --name 'VITE_APP_IDENTITY_POOL_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_PLACES_API=$(aws ssm get-parameter --name 'VITE_APP_PLACES_API' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
          fi

          if [ "$APP_TO_BUILD" = "customer" ]; then
            if [ "$BUILD_ENV" = "staging" ] || [ "$BUILD_ENV" = "stage" ]; then
              echo "NEXT_PUBLIC_API_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_URL_STAGE' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_API_GRAPH_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_GRAPH_URL_STAGE' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            else
              echo "NEXT_PUBLIC_API_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_API_GRAPH_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            fi
            echo "NEXT_PUBLIC_STRIPE_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_STRIPE_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_VAPID_TOKEN=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_VAPID_TOKEN' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_APP_API_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_APP_API_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_PROJECT_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_MESSAGE_SENDER_ID=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_MESSAGE_SENDER_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_APP_ID=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_APP_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
          fi

          if [ "$APP_TO_BUILD" = "co" ]; then
            echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_API_GRAPH_URL=$(aws ssm get-parameter --name 'VITE_APP_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_SOCKET_URL=$(aws ssm get-parameter --name 'VITE_APP_SOCKET_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
          fi

      - name: Build application (Nx only for build)
        run: |
          case "$APP_TO_BUILD" in
            "fe") pnpm exec nx build organisation --configuration=$BUILD_ENV ;;
            "ui") pnpm exec nx build-storybook ui --configuration=$BUILD_ENV ;;
            "admin") pnpm exec nx build admin --configuration=$BUILD_ENV ;;
            "customer") pnpm exec nx build customer --configuration=$BUILD_ENV ;;
            "co") pnpm exec nx build co-screen --configuration=$BUILD_ENV ;;
          esac

      - name: Upload versioned artifacts to S3
        run: |
          case "$APP_TO_BUILD" in
            "ui")
              aws s3 sync dist/lib s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/lib/ --sse aws:kms
              aws s3 sync dist/lib s3://$S3_BUCKET_NAME/artifacts/ui/latest/lib/ --sse aws:kms
              ;;
            "fe")
              aws s3 sync dist/apps/organisation/ s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/organisation/ --sse aws:kms --exclude "node_modules/*"
              aws s3 sync dist/apps/organisation/ s3://$S3_BUCKET_NAME/artifacts/fe/latest/organisation/ --sse aws:kms --exclude "node_modules/*"
              ;;
            "customer")
              tar -czf customer-runtime-${{ steps.version.outputs.version_sha }}.tgz -C dist/apps/customer .
              aws s3 cp customer-runtime-${{ steps.version.outputs.version_sha }}.tgz s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/customer-runtime.tgz --sse aws:kms
              aws s3 cp customer-runtime-${{ steps.version.outputs.version_sha }}.tgz s3://$S3_BUCKET_NAME/artifacts/customer/latest/customer-runtime.tgz --sse aws:kms
              rm -f customer-runtime-*.tgz
              ;;
            "admin")
              aws s3 sync dist/apps/admin/ s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/admin/ --sse aws:kms --exclude "node_modules/*"
              aws s3 sync dist/apps/admin/ s3://$S3_BUCKET_NAME/artifacts/admin/latest/admin/ --sse aws:kms --exclude "node_modules/*"
              ;;
            "co")
              aws s3 sync dist/apps/co-screen/ s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/co-screen/ --sse aws:kms
              aws s3 sync dist/apps/co-screen/ s3://$S3_BUCKET_NAME/artifacts/co/latest/co-screen/ --sse aws:kms
              ;;
          esac

      - name: Nx Self-Healing CI (on failure)
        if: failure()
        run: npx nx fix-ci

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CO to separate EC2 folder (production only)
        if: env.APP_TO_BUILD == 'co'
        run: |
          aws ssm get-parameter --name "ethos-fe" --query "Parameter.Value" --output text > /tmp/private_key.pem
          chmod 400 /tmp/private_key.pem
          ssh -i /tmp/private_key.pem -p 7172 -o StrictHostKeyChecking=no ubuntu@3.210.120.239 "
            set -euo pipefail
            sudo mkdir -p /var/www/html/ethos-orderstatus/dist/apps/co-screen
            aws s3 sync s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}/co-screen/ /var/www/html/ethos-orderstatus/dist/apps/co-screen/ --exact-timestamps --delete
            sudo chown -R www-data:www-data /var/www/html/ethos-orderstatus/dist/apps/co-screen || true
            echo '${{ needs.build.outputs.version_sha }}' | sudo tee /var/www/html/ethos-orderstatus/dist/apps/co-screen/VERSION
          "

      - name: Deploy Customer (with PM2 and health checks)
        if: env.APP_TO_BUILD == 'customer'
        run: |
          TARGET_HOST=$([[ "$BUILD_ENV" == "staging" || "$BUILD_ENV" == "stage" ]] && echo "35.175.98.240" || echo "3.210.120.239")
          TARGET_PREFIX=$([[ "$BUILD_ENV" == "staging" || "$BUILD_ENV" == "stage" ]] && echo "stage" || echo "multi")

          aws ssm get-parameter --name "ethos-fe" --query "Parameter.Value" --output text > /tmp/private_key.pem
          chmod 400 /tmp/private_key.pem

          ssh -i /tmp/private_key.pem -p 7172 -o StrictHostKeyChecking=no ubuntu@$TARGET_HOST "
            set -euo pipefail
            sudo rm -rf /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer/* || true
            sudo mkdir -p /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer || true
            aws s3 cp s3://$S3_BUCKET_NAME/artifacts/customer/latest/customer-runtime.tgz /tmp/customer-runtime.tgz --sse aws:kms
            sudo tar -xzf /tmp/customer-runtime.tgz -C /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer
            sudo chown -R www-data:www-data /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer || true
            echo '${{ needs.build.outputs.version_sha }}' | sudo tee /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer/VERSION
            cd /var/www/html/ethos-$TARGET_PREFIX
            sudo pm2 delete customer || true
            sudo pm2 start npx --name customer --interpreter node -- next start /var/www/html/ethos-$TARGET_PREFIX/dist/apps/customer -p 4200
            sudo pm2 save || true
          "
