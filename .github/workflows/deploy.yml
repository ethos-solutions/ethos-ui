name: Deploy Ethos Applications

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Application to build (fe, ui, admin, customer)'
        required: true
        default: 'customer'
        type: choice
        options:
          - fe
          - ui
          - admin
          - customer
      build_env:
        description: 'Build environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  S3_BUCKET_NAME: "ethos-build"
  BUILD_ENV: ${{ github.event.inputs.build_env || 'production' }}
  APP_TO_BUILD: ${{ github.event.inputs.app_to_build || 'customer' }}
  AWS_REGION: us-east-1
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event.inputs.app_to_build || 'customer' }}
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          
      - name: Setup pnpm (use version from package.json)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
        
      - name: Verify AWS credentials are set
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "‚ùå AWS credentials not found in secrets"
            exit 1
          fi
          echo "‚úÖ AWS credentials verified"
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Get NX Cloud token from Parameter Store
        run: |
          NX_TOKEN=$(aws ssm get-parameter --name "NX_CLOUD_ACCESS_TOKEN" --query "Parameter.Value" --output text)
          echo "NX_CLOUD_ACCESS_TOKEN=$NX_TOKEN" >> $GITHUB_ENV
          echo "NX_CLOUD_ACCESS_TOKEN=$NX_TOKEN" > .env
          echo "‚úÖ Nx Cloud token configured"
          
      - name: Install dependencies
        run: |
          echo "Installing workspace dependencies..."
          pnpm install --frozen-lockfile || pnpm install
          echo "‚úÖ Dependencies installed"
          
      - name: Set environment variables
        run: |
          echo "Setting environment variables for $APP_TO_BUILD..."
          case "$APP_TO_BUILD" in
            "fe")
              echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_API_GRAPH_URL=$(aws ssm get-parameter --name 'VITE_APP_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_SOCKET_URL=$(aws ssm get-parameter --name 'VITE_APP_SOCKET_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_S3_BUCKET_NAME=$(aws ssm get-parameter --name 'VITE_APP_S3_BUCKET_NAME' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_IDENTITY_POOL_ID=$(aws ssm get-parameter --name 'VITE_APP_IDENTITY_POOL_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "VITE_APP_PLACES_API=$(aws ssm get-parameter --name 'VITE_APP_PLACES_API' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              ;;
            "admin")
              echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              ;;
            "customer")
              echo "NEXT_PUBLIC_API_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_API_GRAPH_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_STRIPE_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_STRIPE_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_FIREBASE_VAPID_TOKEN=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_VAPID_TOKEN' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              echo "NEXT_PUBLIC_MP_PUBLIC_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_MP_PUBLIC_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
              ;;
          esac
          echo "‚úÖ Environment variables configured for $APP_TO_BUILD"
          
      - name: Build application with Nx
        run: |
          echo "Building $APP_TO_BUILD application with Nx..."
          case "$APP_TO_BUILD" in
            "fe")
              pnpm exec nx build organisation --configuration=$BUILD_ENV
              ;;
            "ui")
              pnpm exec nx build-storybook ui --configuration=$BUILD_ENV
              ;;
            "admin")
              pnpm exec nx build admin --configuration=$BUILD_ENV
              ;;
            "customer")
              pnpm exec nx build customer --configuration=$BUILD_ENV
              
              if [ ! -d dist/apps/customer ]; then
                echo "‚ùå ERROR: dist/apps/customer not found after build"
                exit 1
              fi
              
              echo "Preparing customer runtime package..."
              cp package.json dist/apps/customer/
              
              echo "Pruning to production dependencies..."
              pnpm -w prune --prod || true
              
              echo "Copying node_modules..."
              mkdir -p dist/apps/customer/node_modules
              rsync -a --del --exclude='.bin' ./node_modules/ dist/apps/customer/node_modules/
              
              echo "Copying .nx-helpers..."
              find dist -type d -name ".nx-helpers" -exec cp -r {} dist/apps/customer/ \; || true
              
              echo "Cleaning trace files..."
              rm -rf dist/apps/customer/.next/trace || true
              
              echo "Creating runtime tarball..."
              cd dist/apps/customer
              tar -czf ../../../customer-runtime.tgz .next public .nx-helpers node_modules package.json next.config.js || exit 1
              cd ../../../
              
              echo "Verifying tarball contents..."
              tar -tf customer-runtime.tgz | grep -i nx-helpers || echo "WARNING: no nx-helpers in tarball"
              ;;
            *)
              echo "‚ùå Invalid APP_TO_BUILD: $APP_TO_BUILD"
              exit 1
              ;;
          esac
          echo "‚úÖ Build completed for $APP_TO_BUILD"
          
      - name: Upload to S3
        run: |
          echo "Uploading $APP_TO_BUILD artifacts to S3..."
          case "$APP_TO_BUILD" in
            "ui")
              aws s3 sync dist/lib s3://$S3_BUCKET_NAME/prod/dist/lib --sse aws:kms
              ;;
            "fe")
              aws s3 sync dist/apps/organisation/ s3://$S3_BUCKET_NAME/prod/dist/apps/organisation/ --sse aws:kms --exact-timestamps --exclude "node_modules/*"
              ;;
            "customer")
              if [ -f customer-runtime.tgz ]; then
                aws s3 cp customer-runtime.tgz s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz --sse aws:kms
                rm -f customer-runtime.tgz
              else
                aws s3 sync dist/apps/customer/ s3://$S3_BUCKET_NAME/prod/dist/apps/customer/ --sse aws:kms --exact-timestamps --exclude "node_modules/*" --exclude "pnpm-lock.yaml" --exclude "package-lock.json"
              fi
              ;;
            "admin")
              aws s3 sync dist/apps/admin/ s3://$S3_BUCKET_NAME/prod/dist/apps/admin/ --sse aws:kms --exact-timestamps --exclude "node_modules/*" --exclude "pnpm-lock.yaml" --exclude "package-lock.json"
              ;;
          esac
          
      - name: Deploy to EC2 (Customer App)
        if: env.APP_TO_BUILD == 'customer'
        run: |
          echo "Retrieving PEM key from SSM..."
          aws ssm get-parameter --name "ethos-fe" --query "Parameter.Value" --output text > /tmp/private_key.pem
          chmod 400 /tmp/private_key.pem
          
          echo "Deploying to EC2..."
          ssh -i /tmp/private_key.pem -p 7172 -o StrictHostKeyChecking=no ubuntu@3.210.120.239 "
            set -euo pipefail
            sudo rm -rf /var/www/html/ethos-multi/dist/apps/customer/* || true
            sudo mkdir -p /var/www/html/ethos-multi/dist/apps/customer || true
            
            if aws s3 ls s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz >/dev/null 2>&1; then
              aws s3 cp s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz /tmp/customer-runtime.tgz --sse aws:kms
              sudo tar -xzf /tmp/customer-runtime.tgz -C /var/www/html/ethos-multi/dist/apps/customer
              rm -f /tmp/customer-runtime.tgz || true
            else
              echo 'Runtime tarball not found in S3; aborting'
              exit 1
            fi
            
            sudo chown -R www-data:www-data /var/www/html/ethos-multi/dist/apps/customer || true
            node -e \"console.log(require('/var/www/html/ethos-multi/dist/apps/customer/package.json').version || 'unknown')\" > /tmp/CUSTOMER_VERSION || true
            sudo mv /tmp/CUSTOMER_VERSION /var/www/html/ethos-multi/dist/apps/customer/VERSION || true
            sudo chown www-data:www-data /var/www/html/ethos-multi/dist/apps/customer/VERSION || true
            
            cd /var/www/html/ethos-multi || true
            sudo pm2 delete customer || true
            sudo pm2 start npx --name customer --interpreter node -- next start /var/www/html/ethos-multi/dist/apps/customer -p 4200
            sudo pm2 save || true
          "
          
      - name: Upload deployment artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-logs-${{ env.APP_TO_BUILD }}-${{ github.run_id }}
          path: |
            dist/
            *.log
            *.tgz
          retention-days: 7
          
      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful for $APP_TO_BUILD application ($BUILD_ENV)"
            echo "üì¶ Artifacts uploaded to S3: s3://$S3_BUCKET_NAME/prod/"
            if [ "$APP_TO_BUILD" = "customer" ]; then
              echo "üöÄ Customer app deployed to EC2 and running on pm2"
            fi
          else
            echo "‚ùå Deployment failed for $APP_TO_BUILD application"
            echo "üìã Check the logs above and uploaded artifacts for debugging"
          fi