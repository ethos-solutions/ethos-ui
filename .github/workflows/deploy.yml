name: Deploy Ethos Applications

on:
  workflow_dispatch:
    inputs:
      app_to_build:
        description: 'Application to build (fe, ui, admin, customer)'
        required: true
        default: 'customer'
        type: choice
        options:
          - fe
          - ui
          - admin
          - customer
      build_env:
        description: 'Build environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  S3_BUCKET_NAME: "ethos-build"
  BUILD_ENV: ${{ github.event.inputs.build_env || 'production' }}
  APP_TO_BUILD: ${{ github.event.inputs.app_to_build || 'customer' }}
  AWS_REGION: us-east-1
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

concurrency:
  group: deploy-${{ github.ref }}-${{ github.event.inputs.app_to_build || 'customer' }}
  cancel-in-progress: false

jobs:
  validate:
    name: Quality gates (lint, type-check, test)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm (use version from package.json)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Lint (production app only)
        run: |
          case "$APP_TO_BUILD" in
            "fe") pnpm exec nx run organisation:lint ;;
            "ui") pnpm exec nx run ui:lint ;;
            "admin") pnpm exec nx run admin:lint ;;
            "customer") pnpm exec nx run customer:lint ;;
            *) echo "Invalid APP_TO_BUILD: $APP_TO_BUILD" && exit 1 ;;
          esac

      - name: Type check (production app only)
        run: |
          case "$APP_TO_BUILD" in
            "fe") pnpm exec nx run organisation:type-check || pnpm exec tsc --noEmit --project tsconfig.base.json ;;
            "ui") pnpm exec nx run ui:type-check || pnpm exec tsc --noEmit --project tsconfig.base.json ;;
            "admin") pnpm exec nx run admin:type-check || pnpm exec tsc --noEmit --project tsconfig.base.json ;;
            "customer") pnpm exec nx run customer:type-check || pnpm exec tsc --noEmit --project tsconfig.base.json ;;
          esac

      - name: Test (production app only)
        run: |
          case "$APP_TO_BUILD" in
            "fe") pnpm exec nx run organisation:test --configuration=ci || echo "No tests found" ;;
            "ui") pnpm exec nx run ui:test --configuration=ci || echo "No tests found" ;;
            "admin") pnpm exec nx run admin:test --configuration=ci || echo "No tests found" ;;
            "customer") pnpm exec nx run customer:test --configuration=ci || echo "No tests found" ;;
          esac

  build:
    name: Build versioned artifacts
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      version_sha: ${{ steps.version.outputs.version_sha }}
      artifact_path: ${{ steps.version.outputs.artifact_path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm (use version from package.json)
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set version and artifact paths
        id: version
        run: |
          VERSION_SHA="${GITHUB_SHA:0:8}"
          ARTIFACT_PATH="artifacts/$APP_TO_BUILD/$VERSION_SHA"
          echo "version_sha=$VERSION_SHA" >> $GITHUB_OUTPUT
          echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION_SHA"
          echo "ğŸ“ Artifact path: s3://$S3_BUCKET_NAME/$ARTIFACT_PATH"

      - name: Set environment variables from Parameter Store
        run: |
          echo "Setting environment variables for $APP_TO_BUILD from SSM..."
          if [ "$APP_TO_BUILD" = "fe" ]; then
            echo "VITE_APP_API_URL=$(aws ssm get-parameter --name 'VITE_APP_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_API_GRAPH_URL=$(aws ssm get-parameter --name 'VITE_APP_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_SOCKET_URL=$(aws ssm get-parameter --name 'VITE_APP_SOCKET_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_S3_BUCKET_NAME=$(aws ssm get-parameter --name 'VITE_APP_S3_BUCKET_NAME' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_IDENTITY_POOL_ID=$(aws ssm get-parameter --name 'VITE_APP_IDENTITY_POOL_ID' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "VITE_APP_PLACES_API=$(aws ssm get-parameter --name 'VITE_APP_PLACES_API' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
          fi

          if [ "$APP_TO_BUILD" = "customer" ]; then
            echo "NEXT_PUBLIC_API_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_API_GRAPH_URL=$(aws ssm get-parameter --name 'NEXT_PUBLIC_API_GRAPH_URL' --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_STRIPE_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_STRIPE_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_FIREBASE_VAPID_TOKEN=$(aws ssm get-parameter --name 'NEXT_PUBLIC_FIREBASE_VAPID_TOKEN' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
            echo "NEXT_PUBLIC_MP_PUBLIC_KEY=$(aws ssm get-parameter --name 'NEXT_PUBLIC_MP_PUBLIC_KEY' --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_ENV
          fi
          echo "âœ… Environment variables configured for $APP_TO_BUILD"

      - name: Build application with Nx
        run: |
          echo "Building $APP_TO_BUILD application with Nx..."
          case "$APP_TO_BUILD" in
            "fe") pnpm exec nx build organisation --configuration=$BUILD_ENV ;;
            "ui") pnpm exec nx build-storybook ui --configuration=$BUILD_ENV ;;
            "admin") pnpm exec nx build admin --configuration=$BUILD_ENV ;;
            "customer")
              pnpm exec nx build customer --configuration=$BUILD_ENV
              test -d dist/apps/customer || (echo "âŒ dist/apps/customer not found" && exit 1)
              cp package.json dist/apps/customer/
              pnpm -w prune --prod || true
              mkdir -p dist/apps/customer/node_modules
              rsync -a --del --exclude='.bin' ./node_modules/ dist/apps/customer/node_modules/
              find dist -type d -name ".nx-helpers" -exec cp -r {} dist/apps/customer/ \; || true
              rm -rf dist/apps/customer/.next/trace || true
              (cd dist/apps/customer && tar -czf ../../../customer-runtime-${{ steps.version.outputs.version_sha }}.tgz .next public .nx-helpers node_modules package.json next.config.js)
              tar -tf customer-runtime-${{ steps.version.outputs.version_sha }}.tgz | grep -i nx-helpers || echo "âš ï¸ WARNING: no nx-helpers in tarball"
              ;;
            *) echo "âŒ Invalid APP_TO_BUILD: $APP_TO_BUILD" && exit 1 ;;
          esac
          echo "âœ… Build completed for $APP_TO_BUILD"

      - name: Upload versioned artifacts to S3
        run: |
          echo "ğŸ“¦ Uploading versioned artifacts to S3..."
          case "$APP_TO_BUILD" in
            "ui")
              aws s3 sync dist/lib s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/lib/ --sse aws:kms
              aws s3 sync dist/lib s3://$S3_BUCKET_NAME/artifacts/ui/latest/lib/ --sse aws:kms
              ;;
            "fe")
              aws s3 sync dist/apps/organisation/ s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/organisation/ --sse aws:kms --exclude "node_modules/*"
              aws s3 sync dist/apps/organisation/ s3://$S3_BUCKET_NAME/artifacts/fe/latest/organisation/ --sse aws:kms --exclude "node_modules/*"
              ;;
            "customer")
              aws s3 cp customer-runtime-${{ steps.version.outputs.version_sha }}.tgz s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/customer-runtime.tgz --sse aws:kms
              aws s3 cp customer-runtime-${{ steps.version.outputs.version_sha }}.tgz s3://$S3_BUCKET_NAME/artifacts/customer/latest/customer-runtime.tgz --sse aws:kms
              rm -f customer-runtime-*.tgz
              ;;
            "admin")
              aws s3 sync dist/apps/admin/ s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}/admin/ --sse aws:kms --exclude "node_modules/*"
              aws s3 sync dist/apps/admin/ s3://$S3_BUCKET_NAME/artifacts/admin/latest/admin/ --sse aws:kms --exclude "node_modules/*"
              ;;
          esac
          echo "âœ… Versioned artifacts uploaded to s3://$S3_BUCKET_NAME/${{ steps.version.outputs.artifact_path }}"

  deploy:
    name: Deploy with enhanced rollback protection
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create timestamped backup of current production (rollback protection)
        if: env.APP_TO_BUILD == 'customer'
        run: |
          BACKUP_TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          BACKUP_PATH="backups/customer/$BACKUP_TIMESTAMP"
          echo "ğŸ›¡ï¸ Creating production backup: s3://$S3_BUCKET_NAME/$BACKUP_PATH"
          
          if aws s3 ls s3://$S3_BUCKET_NAME/prod/dist/apps/customer/ >/dev/null 2>&1; then
            aws s3 sync s3://$S3_BUCKET_NAME/prod/dist/apps/customer/ s3://$S3_BUCKET_NAME/$BACKUP_PATH/ --sse aws:kms
            echo "âœ… Backup created: s3://$S3_BUCKET_NAME/$BACKUP_PATH"
            echo "BACKUP_PATH=$BACKUP_PATH" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No existing production deployment found to backup"
            echo "BACKUP_PATH=" >> $GITHUB_ENV
          fi

      - name: Deploy versioned artifacts to production
        run: |
          echo "ğŸš€ Deploying $APP_TO_BUILD version ${{ needs.build.outputs.version_sha }}..."
          case "$APP_TO_BUILD" in
            "ui")
              aws s3 sync s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}/lib/ s3://$S3_BUCKET_NAME/prod/dist/lib/ --sse aws:kms --delete
              ;;
            "fe")
              aws s3 sync s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}/organisation/ s3://$S3_BUCKET_NAME/prod/dist/apps/organisation/ --sse aws:kms --delete
              ;;
            "customer")
              aws s3 cp s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}/customer-runtime.tgz s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz --sse aws:kms
              ;;
            "admin")
              aws s3 sync s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}/admin/ s3://$S3_BUCKET_NAME/prod/dist/apps/admin/ --sse aws:kms --delete
              ;;
          esac
          echo "âœ… Artifacts deployed to production S3"

      - name: Deploy to EC2 (Customer App)
        if: env.APP_TO_BUILD == 'customer'
        run: |
          echo "ğŸ–¥ï¸ Deploying to EC2 server..."
          aws ssm get-parameter --name "ethos-fe" --query "Parameter.Value" --output text > /tmp/private_key.pem
          chmod 400 /tmp/private_key.pem

          ssh -i /tmp/private_key.pem -p 7172 -o StrictHostKeyChecking=no ubuntu@3.210.120.239 "
            set -euo pipefail
            echo 'ğŸ—‚ï¸ Cleaning old deployment directory...'
            sudo rm -rf /var/www/html/ethos-multi/dist/apps/customer/* || true
            sudo mkdir -p /var/www/html/ethos-multi/dist/apps/customer || true

            echo 'ğŸ“¦ Downloading runtime artifact from S3...'
            if aws s3 ls s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz >/dev/null 2>&1; then
              aws s3 cp s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz /tmp/customer-runtime.tgz --sse aws:kms
              echo 'ğŸ“‚ Extracting runtime to deployment directory...'
              sudo tar -xzf /tmp/customer-runtime.tgz -C /var/www/html/ethos-multi/dist/apps/customer
              rm -f /tmp/customer-runtime.tgz || true
            else
              echo 'âŒ Runtime artifact not found in S3'
              exit 1
            fi

            echo 'ğŸ‘¤ Setting file ownership...'
            sudo chown -R www-data:www-data /var/www/html/ethos-multi/dist/apps/customer || true
            
            echo 'ğŸ“‹ Recording deployment version...'
            echo '${{ needs.build.outputs.version_sha }}' | sudo tee /var/www/html/ethos-multi/dist/apps/customer/VERSION
            sudo chown www-data:www-data /var/www/html/ethos-multi/dist/apps/customer/VERSION || true

            echo 'ğŸ”„ Restarting application with pm2...'
            cd /var/www/html/ethos-multi || true
            sudo pm2 delete customer || true
            sudo pm2 start npx --name customer --interpreter node -- next start /var/www/html/ethos-multi/dist/apps/customer -p 4200
            sudo pm2 save || true
            echo 'âœ… EC2 deployment completed'
          "

      - name: Enhanced health check with retry logic
        if: env.APP_TO_BUILD == 'customer'
        run: |
          echo "ğŸ¥ Running enhanced health checks..."
          SUCCESS=false
          
          for i in {1..15}; do
            echo "Health check attempt $i/15..."
            
            # Basic connectivity
            if ! curl -s --max-time 10 http://3.210.120.239:4200/ >/dev/null; then
              echo "âŒ Basic connectivity failed"
              sleep 10
              continue
            fi
            
            # Health endpoint (if exists)
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://3.210.120.239:4200/health || echo "000")
            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "âœ… Health endpoint responded successfully"
              SUCCESS=true
              break
            elif [ "$HEALTH_STATUS" = "404" ]; then
              # Health endpoint might not exist, check main page
              MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://3.210.120.239:4200/ || echo "000")
              if [ "$MAIN_STATUS" = "200" ]; then
                echo "âœ… Main page responded successfully (health endpoint not found)"
                SUCCESS=true
                break
              fi
            fi
            
            echo "â³ Health not ready (health: $HEALTH_STATUS). Retrying in 10s..."
            sleep 10
          done
          
          if [ "$SUCCESS" = "true" ]; then
            echo "ğŸ‰ Health checks passed - deployment successful!"
          else
            echo "ğŸ’¥ Health checks failed after 15 attempts - triggering rollback"
            exit 1
          fi

      - name: Emergency rollback on any failure
        if: failure() && env.APP_TO_BUILD == 'customer' && env.BACKUP_PATH != ''
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILED - Starting emergency rollback..."
          echo "ğŸ“¼ Restoring from backup: s3://$S3_BUCKET_NAME/$BACKUP_PATH"
          
          # Restore S3 artifacts
          aws s3 sync s3://$S3_BUCKET_NAME/$BACKUP_PATH/ s3://$S3_BUCKET_NAME/prod/dist/apps/customer/ --sse aws:kms --delete
          echo "âœ… S3 artifacts restored from backup"
          
          # Restore EC2 deployment
          ssh -i /tmp/private_key.pem -p 7172 -o StrictHostKeyChecking=no ubuntu@3.210.120.239 "
            set -euo pipefail
            echo 'ğŸ”„ Redeploying backup version to EC2...'
            sudo rm -rf /var/www/html/ethos-multi/dist/apps/customer/* || true
            
            if aws s3 ls s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz >/dev/null 2>&1; then
              aws s3 cp s3://$S3_BUCKET_NAME/prod/dist/apps/customer/customer-runtime.tgz /tmp/customer-runtime-rollback.tgz --sse aws:kms
              sudo tar -xzf /tmp/customer-runtime-rollback.tgz -C /var/www/html/ethos-multi/dist/apps/customer
              rm -f /tmp/customer-runtime-rollback.tgz || true
              sudo chown -R www-data:www-data /var/www/html/ethos-multi/dist/apps/customer || true
              
              echo 'ğŸ”„ Restarting with previous version...'
              cd /var/www/html/ethos-multi
              sudo pm2 delete customer || true
              sudo pm2 start npx --name customer --interpreter node -- next start /var/www/html/ethos-multi/dist/apps/customer -p 4200
              sudo pm2 save || true
              echo 'âœ… Emergency rollback completed - previous version restored'
            else
              echo 'âŒ Could not restore - manual intervention required'
            fi
          "
          
          echo "ğŸ›¡ï¸ ROLLBACK COMPLETED - Production should be serving previous version"

      - name: Upload deployment logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-failure-logs-${{ env.APP_TO_BUILD }}-${{ github.run_id }}
          path: |
            *.log
          retention-days: 14

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ DEPLOYMENT SUCCESSFUL"
            echo "ğŸ“± App: $APP_TO_BUILD"
            echo "ğŸ·ï¸ Version: ${{ needs.build.outputs.version_sha }}"
            echo "ğŸŒ Environment: $BUILD_ENV"
            echo "ğŸ“¦ Artifacts: s3://$S3_BUCKET_NAME/${{ needs.build.outputs.artifact_path }}"
            if [ "$APP_TO_BUILD" = "customer" ]; then
              echo "ğŸ”— Service: http://3.210.120.239:4200/"
            fi
          else
            echo "ğŸ’¥ DEPLOYMENT FAILED"
            echo "ğŸ“± App: $APP_TO_BUILD"
            echo "ğŸ·ï¸ Attempted Version: ${{ needs.build.outputs.version_sha }}"
            if [ -n "${BACKUP_PATH:-}" ]; then
              echo "ğŸ›¡ï¸ Rollback: Previous version restored from s3://$S3_BUCKET_NAME/$BACKUP_PATH"
              echo "âœ… Production should be stable and serving previous version"
            else
              echo "âš ï¸ No backup available - check production status manually"
            fi
          fi